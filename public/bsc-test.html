<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSC API Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background: #1a1a1a; 
            color: #fff; 
            padding: 20px; 
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
        }
        .test-section { 
            background: #2a2a2a; 
            border: 1px solid #444; 
            border-radius: 8px; 
            padding: 20px; 
            margin: 20px 0; 
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover { background: #0056b3; }
        .result { 
            background: #1e1e1e; 
            border: 1px solid #555; 
            border-radius: 5px; 
            padding: 15px; 
            margin: 10px 0; 
            white-space: pre-wrap; 
            max-height: 400px; 
            overflow-y: auto; 
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        input { 
            background: #333; 
            color: white; 
            border: 1px solid #555; 
            padding: 8px; 
            border-radius: 4px; 
            width: 100%; 
            margin: 5px 0; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ BSC API Test - –û—Ç–ª–∞–¥–∫–∞ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã</h1>
        
        <div class="test-section">
            <h3>üéØ –í–∞—à –∫–æ—à–µ–ª–µ–∫</h3>
            <input type="text" id="walletAddress" value="0x0476d0b67e7e7e2654F16b31F807868FAf726588" placeholder="BSC Address">
            <input type="number" id="expectedAmount" value="0.0005" step="0.0001" placeholder="Expected BNB Amount">
            
            <button onclick="testDirectAPI()">üì° Test Direct BSCScan API</button>
            <button onclick="testProxyAPI()">üîÑ Test Server Proxy API</button>
            <button onclick="testSpecificAmount()">üéØ Check Specific Amount</button>
            <button onclick="clearResults()">üßπ Clear</button>
        </div>

        <div class="test-section">
            <h3>üìä Results</h3>
            <div id="results" class="result">
–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é...

üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:
1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∞—à –∞–¥—Ä–µ—Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
2. –£–∫–∞–∂–∏—Ç–µ —Ç–æ—á–Ω—É—é —Å—É–º–º—É, –∫–æ—Ç–æ—Ä—É—é –æ—Ç–ø—Ä–∞–≤–∏–ª–∏  
3. –ù–∞–∂–º–∏—Ç–µ "Test Direct BSCScan API" —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
4. –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ "Test Server Proxy API"
            </div>
        </div>
    </div>

    <script>
        const results = document.getElementById('results');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'success': '#28a745',
                'error': '#dc3545', 
                'warning': '#ffc107',
                'info': '#17a2b8'
            };
            
            results.innerHTML += `<span style="color: ${colors[type]}">[${timestamp}] ${message}</span>\n`;
            results.scrollTop = results.scrollHeight;
        }
        
        function clearResults() {
            results.innerHTML = 'Results cleared...\n';
        }
        
        async function testDirectAPI() {
            const address = document.getElementById('walletAddress').value;
            log('üîç Testing Direct BSCScan API...', 'info');
            log(`üìç Address: ${address}`, 'info');
            
            try {
                const url = `https://api.bscscan.com/api?module=account&action=txlist&address=${address}&startblock=0&endblock=99999999&page=1&offset=20&sort=desc`;
                log(`üì° URL: ${url}`, 'info');
                
                const response = await fetch(url);
                log(`üìä Response Status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log(`‚úÖ API Response received`, 'success');
                log(`üìã Status: ${data.status}`, data.status === '1' ? 'success' : 'error');
                log(`üìä Message: ${data.message}`, 'info');
                
                if (data.status === '1' && data.result && Array.isArray(data.result)) {
                    log(`üéØ Found ${data.result.length} transactions`, 'success');
                    
                    // Show last 5 transactions
                    data.result.slice(0, 5).forEach((tx, index) => {
                        const amount = parseFloat(tx.value) / Math.pow(10, 18);
                        const date = new Date(parseInt(tx.timeStamp) * 1000);
                        const isIncoming = tx.to && tx.to.toLowerCase() === address.toLowerCase();
                        
                        log(``, 'info');
                        log(`üìã Transaction ${index + 1}:`, 'warning');
                        log(`  üí∞ Amount: ${amount} BNB`, 'info');
                        log(`  üìÖ Date: ${date.toLocaleString()}`, 'info');
                        log(`  üîÑ Type: ${isIncoming ? 'INCOMING ‚úÖ' : 'OUTGOING ‚ùå'}`, isIncoming ? 'success' : 'warning');
                        log(`  üìç From: ${tx.from}`, 'info');
                        log(`  üìç To: ${tx.to}`, 'info');
                        log(`  üîó Hash: ${tx.hash}`, 'info');
                    });
                } else {
                    log(`‚ùå No transactions found or API error`, 'error');
                    log(`üîç Full response: ${JSON.stringify(data, null, 2)}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Direct API Error: ${error.message}`, 'error');
                log(`üí° This is likely due to CORS restrictions`, 'warning');
            }
        }
        
        async function testProxyAPI() {
            const address = document.getElementById('walletAddress').value;
            log('üîÑ Testing Server Proxy API...', 'info');
            
            try {
                const url = `/api/bsc/${address}`;
                log(`üì° Proxy URL: ${url}`, 'info');
                
                const response = await fetch(url);
                log(`üìä Proxy Response Status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log(`‚úÖ Proxy API Response received`, 'success');
                log(`üìã Status: ${data.status}`, data.status === '1' ? 'success' : 'error');
                log(`üìä Message: ${data.message}`, 'info');
                
                if (data.status === '1' && data.result && Array.isArray(data.result)) {
                    log(`üéØ Found ${data.result.length} transactions via proxy`, 'success');
                    
                    // Show all transactions
                    data.result.forEach((tx, index) => {
                        const amount = parseFloat(tx.value) / Math.pow(10, 18);
                        const date = new Date(parseInt(tx.timeStamp) * 1000);
                        const isIncoming = tx.to && tx.to.toLowerCase() === address.toLowerCase();
                        
                        log(``, 'info');
                        log(`üìã Transaction ${index + 1}:`, 'warning');
                        log(`  üí∞ Amount: ${amount.toFixed(6)} BNB`, 'info');
                        log(`  üìÖ Date: ${date.toLocaleString()}`, 'info');
                        log(`  üîÑ Type: ${isIncoming ? 'INCOMING ‚úÖ' : 'OUTGOING ‚ùå'}`, isIncoming ? 'success' : 'warning');
                        log(`  üìç From: ${tx.from}`, 'info');
                        log(`  üìç To: ${tx.to}`, 'info');
                        log(`  üîó Hash: ${tx.hash}`, 'info');
                        
                        // Check if this matches our expected amount
                        const expectedAmount = parseFloat(document.getElementById('expectedAmount').value);
                        if (Math.abs(amount - expectedAmount) <= 0.0001 && isIncoming) {
                            log(`  üéØ MATCH! This matches expected amount ${expectedAmount} BNB`, 'success');
                        }
                    });
                } else {
                    log(`‚ùå No transactions found via proxy`, 'error');
                    log(`üîç Full response: ${JSON.stringify(data, null, 2)}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Proxy API Error: ${error.message}`, 'error');
            }
        }
        
        async function testSpecificAmount() {
            const address = document.getElementById('walletAddress').value;
            const expectedAmount = parseFloat(document.getElementById('expectedAmount').value);
            
            log(`üéØ Looking for specific amount: ${expectedAmount} BNB`, 'warning');
            log(`üìç On address: ${address}`, 'info');
            
            try {
                const url = `/api/bsc/${address}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.status === '1' && data.result && Array.isArray(data.result)) {
                    let found = false;
                    
                    data.result.forEach((tx, index) => {
                        const amount = parseFloat(tx.value) / Math.pow(10, 18);
                        const date = new Date(parseInt(tx.timeStamp) * 1000);
                        const isIncoming = tx.to && tx.to.toLowerCase() === address.toLowerCase();
                        
                        // Check if amount matches (within 0.0001 tolerance)
                        if (Math.abs(amount - expectedAmount) <= 0.0001 && isIncoming) {
                            found = true;
                            log(``, 'info');
                            log(`üéØ FOUND MATCHING TRANSACTION!`, 'success');
                            log(`  üí∞ Amount: ${amount.toFixed(6)} BNB (expected: ${expectedAmount})`, 'success');
                            log(`  üìÖ Date: ${date.toLocaleString()}`, 'success');
                            log(`  üìç From: ${tx.from}`, 'success');
                            log(`  üîó Hash: ${tx.hash}`, 'success');
                            log(`  ‚úÖ This transaction should be detected by the payment system!`, 'success');
                        }
                    });
                    
                    if (!found) {
                        log(`‚ùå No matching transaction found for ${expectedAmount} BNB`, 'error');
                        log(`üí° Possible reasons:`, 'warning');
                        log(`   - Transaction not yet confirmed`, 'warning');
                        log(`   - Amount doesn't match exactly`, 'warning');
                        log(`   - Transaction is outgoing, not incoming`, 'warning');
                        log(`   - Transaction is older than API limit`, 'warning');
                    }
                } else {
                    log(`‚ùå API call failed`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html> 