const TelegramBot = require('node-telegram-bot-api');

// –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
const BOT_TOKEN = '8223532804:AAHXZ_u0qM9NOFrnPp5-I6Ey0GmrfGLteAg';
const WEB_APP_URL = 'https://t.me/Eagle_Scanner_bot/EScanner'; // URL –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

const bot = new TelegramBot(BOT_TOKEN, { polling: true });

console.log('ü§ñ Eagle Scanner Bot started!');

// –ö–æ–º–∞–Ω–¥–∞ /start
bot.onText(/\/start/, (msg) => {
    const chatId = msg.chat.id;
    const userId = msg.from.id;
    const firstName = msg.from.first_name || 'User';
    
    console.log(`üë§ User ${firstName} (${userId}) started the bot`);
    
    const welcomeMessage = `
ü¶Ö *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Eagle Scanner!*

–ü—Ä–∏–≤–µ—Ç, ${firstName}! üëã

Eagle Scanner - —ç—Ç–æ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —Å–∫–∞–Ω–µ—Ä –∫—Ä–∏–ø—Ç–æ–∫–æ—à–µ–ª—å–∫–æ–≤ —Å —Å–∏—Å—Ç–µ–º–æ–π –±—É—Å—Ç–æ–≤.

üöÄ *–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:*
‚Ä¢ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–æ–≤ —Å –≤—ã—Å–æ–∫–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é
‚Ä¢ –°–∏—Å—Ç–µ–º–∞ –±—É—Å—Ç–æ–≤ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏
‚Ä¢ NFT –¥–µ—Ç–µ–∫—Ç–æ—Ä
‚Ä¢ –î–∂–µ–∫–ø–æ—Ç —Å–∏—Å—Ç–µ–º–∞
‚Ä¢ –†—ã–Ω–æ–∫ –∞–ø–≥—Ä–µ–π–¥–æ–≤

üí∞ *–¢–∞—Ä–∏—Ñ—ã:*
‚Ä¢ –ë–∞–∑–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å: 1 –∫–æ—à–µ–ª–µ–∫/—Å–µ–∫
‚Ä¢ –° –±—É—Å—Ç–∞–º–∏: –¥–æ 100 –∫–æ—à–µ–ª—å–∫–æ–≤/—Å–µ–∫
‚Ä¢ Find Rate: –æ—Ç 5% –¥–æ 70%

–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ! üëá
    `;
    
    const options = {
        parse_mode: 'Markdown',
        reply_markup: {
            inline_keyboard: [
                [
                    {
                        text: 'üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å Eagle Scanner',
                        web_app: { url: WEB_APP_URL }
                    }
                ],
                [
                    {
                        text: 'üõí –û—Ç–∫—Ä—ã—Ç—å –ú–∞—Ä–∫–µ—Ç',
                        web_app: { url: `${WEB_APP_URL}#market` }
                    }
                ],
                [
                    {
                        text: 'üéÆ –î–∂–µ–∫–ø–æ—Ç',
                        web_app: { url: `${WEB_APP_URL}#games` }
                    },
                    {
                        text: 'üë§ –ü—Ä–æ—Ñ–∏–ª—å',
                        callback_data: 'profile'
                    }
                ],
                [
                    {
                        text: '‚ùì –ü–æ–º–æ—â—å',
                        callback_data: 'help'
                    },
                    {
                        text: 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
                        callback_data: 'stats'
                    }
                ]
            ]
        }
    };
    
    bot.sendMessage(chatId, welcomeMessage, options);
});

// –ö–æ–º–∞–Ω–¥–∞ /help
bot.onText(/\/help/, (msg) => {
    const chatId = msg.chat.id;
    
    const helpMessage = `
‚ùì *–ü–æ–º–æ—â—å - Eagle Scanner*

üîß *–ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞:*
/start - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
/help - –≠—Ç–∞ –ø–æ–º–æ—â—å
/profile - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ñ–∏–ª–µ
/market - –û—Ç–∫—Ä—ã—Ç—å –º–∞—Ä–∫–µ—Ç
/scanner - –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä

üöÄ *–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:*

1Ô∏è‚É£ *–ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞*
‚Ä¢ –ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å Eagle Scanner"
‚Ä¢ –í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã –¥–ª—è –ø–æ–∏—Å–∫–∞
‚Ä¢ –ù–∞–∂–º–∏—Ç–µ "Start Neural Scan"

2Ô∏è‚É£ *–ü–æ–∫—É–ø–∫–∞ –±—É—Å—Ç–æ–≤*
‚Ä¢ –û—Ç–∫—Ä–æ–π—Ç–µ "–ú–∞—Ä–∫–µ—Ç"
‚Ä¢ –í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π –±—É—Å—Ç
‚Ä¢ –û–ø–ª–∞—Ç–∏—Ç–µ USDT/BNB/TRX
‚Ä¢ –ë—É—Å—Ç –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

3Ô∏è‚É£ *–î–∂–µ–∫–ø–æ—Ç —Å–∏—Å—Ç–µ–º–∞*
‚Ä¢ –ò–≥—Ä–∞–π—Ç–µ –≤ Lucky Wheel
‚Ä¢ –í—ã–∏–≥—Ä—ã–≤–∞–π—Ç–µ –º–æ—â–Ω—ã–µ –±—É—Å—Ç—ã
‚Ä¢ –ö—É–ª–¥–∞—É–Ω –ø–æ—Å–ª–µ –≤—ã–∏–≥—Ä—ã—à–∞

üí° *–¢–∞—Ä–∏—Ñ—ã:*
‚Ä¢ 10x Boost - 30 USDT
‚Ä¢ 20x Boost - 50 USDT  
‚Ä¢ 50x Boost - 100 USDT
‚Ä¢ 100x Boost - 150 USDT
‚Ä¢ NFT Scanner - 30 USDT

üÜò *–ü–æ–¥–¥–µ—Ä–∂–∫–∞:* @support_username
    `;
    
    bot.sendMessage(chatId, helpMessage, { parse_mode: 'Markdown' });
});

// –ö–æ–º–∞–Ω–¥–∞ /profile
bot.onText(/\/profile/, (msg) => {
    const chatId = msg.chat.id;
    const userId = msg.from.id;
    const firstName = msg.from.first_name || 'User';
    
    const profileMessage = `
üë§ *–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è*

üÜî *ID:* \`${userId}\`
üë§ *–ò–º—è:* ${firstName}
üìÖ *–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:* ${new Date().toLocaleDateString()}

üöÄ *–°—Ç–∞—Ç—É—Å –±—É—Å—Ç–æ–≤:*
–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—É—Å—Ç–æ–≤ –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.

üí∞ *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:*
‚Ä¢ –ö–æ—à–µ–ª—å–∫–æ–≤ –ø—Ä–æ—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: -
‚Ä¢ –ù–∞–π–¥–µ–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤: -
‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö –±—É—Å—Ç–æ–≤: -

üì± –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏!
    `;
    
    const options = {
        parse_mode: 'Markdown',
        reply_markup: {
            inline_keyboard: [
                [
                    {
                        text: 'üì± –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ',
                        web_app: { url: WEB_APP_URL }
                    }
                ]
            ]
        }
    };
    
    bot.sendMessage(chatId, profileMessage, options);
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ callback –∫–Ω–æ–ø–æ–∫
bot.on('callback_query', (callbackQuery) => {
    const message = callbackQuery.message;
    const data = callbackQuery.data;
    const chatId = message.chat.id;
    const userId = callbackQuery.from.id;
    
    console.log(`üîò Callback: ${data} from user ${userId}`);
    
    // –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å "–∑–∞–≥—Ä—É–∑–∫—É"
    bot.answerCallbackQuery(callbackQuery.id);
    
    switch (data) {
        case 'profile':
            bot.sendMessage(chatId, `
üë§ *–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å*

üÜî User ID: \`${userId}\`
üì± Telegram: @${callbackQuery.from.username || 'No username'}
üéÆ –°—Ç–∞—Ç—É—Å: –ê–∫—Ç–∏–≤–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

üöÄ –î–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ!
            `, { 
                parse_mode: 'Markdown',
                reply_markup: {
                    inline_keyboard: [[
                        { text: 'üì± –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', web_app: { url: WEB_APP_URL } }
                    ]]
                }
            });
            break;
            
        case 'help':
            bot.sendMessage(chatId, `
‚ùì *–ë—ã—Å—Ç—Ä–∞—è –ø–æ–º–æ—â—å*

üöÄ *–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:*
‚Ä¢ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–æ–≤
‚Ä¢ –ü–æ–∫—É–ø–∫–∞ –±—É—Å—Ç–æ–≤
‚Ä¢ –î–∂–µ–∫–ø–æ—Ç –∏–≥—Ä—ã
‚Ä¢ NFT –¥–µ—Ç–µ–∫—Ç–æ—Ä

üí∞ *–û–ø–ª–∞—Ç–∞:*
‚Ä¢ USDT (TRC-20)
‚Ä¢ BNB (BSC)
‚Ä¢ TRX (TRON)

üÜò *–ü–æ–¥–¥–µ—Ä–∂–∫–∞:* @support_username
            `, { parse_mode: 'Markdown' });
            break;
            
        default:
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞
            if (data.startsWith('copy_code_')) {
                const code = data.replace('copy_code_', '');
                bot.answerCallbackQuery(callbackQuery.id, `‚úÖ –ö–æ–¥ ${code} —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!`);
                console.log(`üìã Code ${code} copied by user ${userId}`);
            }
            break;
            
        case 'stats':
            bot.sendMessage(chatId, `
üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Eagle Scanner*

üë• *–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:*
‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 1,234
‚Ä¢ –ö–æ—à–µ–ª—å–∫–æ–≤ –ø—Ä–æ—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: 5,678,901
‚Ä¢ –ù–∞–π–¥–µ–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤: 12,345
‚Ä¢ –í—ã–ø–ª–∞—á–µ–Ω–æ –Ω–∞–≥—Ä–∞–¥: $45,678

üöÄ *–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –±—É—Å—Ç—ã:*
‚Ä¢ 10x Boost - 45% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚Ä¢ 100x Boost - 23% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚Ä¢ NFT Scanner - 67% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

üìà *–°–µ–≥–æ–¥–Ω—è:*
‚Ä¢ –ù–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: +89
‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π: 456
‚Ä¢ –ü–æ–∫—É–ø–æ–∫ –≤ –º–∞—Ä–∫–µ—Ç–µ: 23
            `, { parse_mode: 'Markdown' });
            break;
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç Web App
bot.on('web_app_data', (msg) => {
    const chatId = msg.chat.id;
    const data = JSON.parse(msg.web_app.data);
    
    console.log('üì± Web App Data:', data);
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –æ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    switch (data.type) {
        case 'admin_boost_grant':
            // –ù–û–í–û–ï: –ê–¥–º–∏–Ω –≤—ã–¥–∞–µ—Ç –±—É—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            handleAdminBoostGrant(chatId, data);
            break;
            
        case 'purchase_completed':
            bot.sendMessage(chatId, `
‚úÖ *–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞!*

üõí –¢–æ–≤–∞—Ä: ${data.productName}
üí∞ –°—É–º–º–∞: ${data.amount} ${data.currency}
‚è∞ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${data.duration}

–ë—É—Å—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! –£–¥–∞—á–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è! üöÄ
            `, { parse_mode: 'Markdown' });
            break;
            
        case 'jackpot_win':
            bot.sendMessage(chatId, `
üéâ *–î–ñ–ï–ö–ü–û–¢!*

üé∞ –í—ã–ø–∞–ª–æ: ${data.symbols}
üöÄ –í—ã–∏–≥—Ä—ã—à: ${data.boost}
‚è∞ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${data.duration}

–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –≤—ã–∏–≥—Ä—ã—à–µ–º! üéä
            `, { parse_mode: 'Markdown' });
            break;
            
        case 'scan_completed':
            bot.sendMessage(chatId, `
üìä *–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ*

üîç –ü—Ä–æ—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: ${data.scanned} –∫–æ—à–µ–ª—å–∫–æ–≤
üí∞ –ù–∞–π–¥–µ–Ω–æ: ${data.found} —Ç–æ–∫–µ–Ω–æ–≤
‚ö° –°–∫–æ—Ä–æ—Å—Ç—å: ${data.speed} –∫–æ—à–µ–ª—å–∫–æ–≤/—Å–µ–∫

–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! üí™
            `, { parse_mode: 'Markdown' });
            break;
    }
});

// === –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–¥–∞—á–∏ –±—É—Å—Ç–∞ –∞–¥–º–∏–Ω–æ–º ===
async function handleAdminBoostGrant(adminChatId, data) {
    console.log('üîê Admin boost grant received:', data);
    
    const { targetUserId, boostData, activationCode, adminId } = data;
    
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ü–µ–ª–µ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å –∫–æ–¥–æ–º
        const timeLeft = Math.round((boostData.endTime - Date.now()) / 60000);
        const notificationMessage = `
üéâ *–í–∞–º –≤—ã–¥–∞–Ω –±—É—Å—Ç –æ—Ç –∞–¥–º–∏–Ω–∞!*

üöÄ *–ë—É—Å—Ç:* ${boostData.productName}
‚ö° *–ú—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä:* ${boostData.multiplier}x
‚è∞ *–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:* ${timeLeft} –º–∏–Ω—É—Ç

üîë *–ö–æ–¥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏:* \`${activationCode}\`

üë®‚Äçüíº *–û—Ç –∞–¥–º–∏–Ω–∞:* ${adminId}

–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏! üëá
        `;
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å –∫–Ω–æ–ø–∫–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
        await bot.sendMessage(targetUserId, notificationMessage, { 
            parse_mode: 'Markdown',
            reply_markup: {
                inline_keyboard: [
                    [
                        {
                            text: 'üöÄ –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ',
                            web_app: { url: WEB_APP_URL }
                        }
                    ],
                    [
                        {
                            text: 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥',
                            callback_data: `copy_code_${activationCode}`
                        }
                    ]
                ]
            }
        });
        
        console.log(`‚úÖ Boost notification with code sent to user ${targetUserId}`);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É
        await bot.sendMessage(adminChatId, `‚úÖ –ë—É—Å—Ç ${boostData.multiplier}x —Å –∫–æ–¥–æ–º ${activationCode} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${targetUserId}!`);
        
    } catch (error) {
        console.error('‚ùå Error sending boost notification:', error);
        
        // –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞ –æ–± –æ—à–∏–±–∫–µ
        try {
            await bot.sendMessage(adminChatId, `‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –±—É—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${targetUserId}: ${error.message}`);
        } catch (e) {
            console.error('‚ùå Failed to send error message to admin:', e);
        }
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
bot.on('error', (error) => {
    console.error('‚ùå Bot error:', error);
});

bot.on('polling_error', (error) => {
    console.error('‚ùå Polling error:', error);
});

console.log('‚úÖ Eagle Scanner Bot is ready!');
console.log('üì± Web App URL:', WEB_APP_URL);
console.log('üîó Bot link: https://t.me/eagle_scanner_bot');

module.exports = bot; 
